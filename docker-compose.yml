services:
  dotnetapi:
    container_name: dotnetapi
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "5110:5110"
    depends_on:
      mongodb:
        condition: service_healthy
      mongodb-seed:
        condition: service_completed_successfully
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5110
      - MongoDB__ConnectionString=mongodb://mongodb:27017/?replicaSet=rs0&directConnection=true
      - MongoDB__DatabaseName=amldb

  mongodb:
    container_name: mongodb
    image: mongo:8.0.9
    ports:
      - "27017:27017"
    restart: always
    command: ["mongod", "--replSet", "rs0", "--bind_ip_all"]
    volumes:
      - mongo-data:/data/db
    healthcheck:
      test: |
        mongosh --quiet --eval "
          try { rs.status() } catch (e) {
            rs.initiate({_id:'rs0', members:[{_id:0, host:'mongodb:27017'}]})
          }
          s = rs.status()
          if (s.myState != 1) quit(1)
        "
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 10s

  mongodb-seed:
    container_name: mongodb-seed
    image: mongo:8.0.9
    depends_on:
      mongodb:
        condition: service_healthy
    restart: "no"
    volumes:
      - ./data:/seed:ro
    command: ["bash", "/seed/seed.sh"]

volumes:
  mongo-data:
